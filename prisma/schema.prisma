generator client {
  provider = "prisma-client"
  output   = "../lib/prisma/generated"
}

datasource db {
  provider = "postgresql"
}

model Profile {
  id       String  @id @map("id") @db.Uuid
  username String  @unique @map("username") @db.VarChar(50)
  isAdmin  Boolean @default(false) @map("is_admin")

  trackedNutrients     TrackedNutrient[]
  foods                Food[]
  favouriteFoods       FavouriteFood[]
  servingCostOverrides ServingCostOverride[]
  creations            Creation[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("profiles")
}

model Nutrient {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String @unique @map("name") @db.VarChar(100)
  servingName  String @unique @map("serving_name") @db.VarChar(100)
  displayOrder Int    @unique @map("display_order")
  unit         String @map("unit") @db.VarChar(50)

  trackedNutrients TrackedNutrient[]

  @@map("nutrients")
}

model TrackedNutrient {
  user       Profile  @relation(fields: [userId], references: [id])
  userId     String   @map("user_id") @db.Uuid
  nutrient   Nutrient @relation(fields: [nutrientId], references: [id])
  nutrientId String   @map("nutrient_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  @@id([userId, nutrientId])
  @@map("tracked_nutrients")
}

model Food {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @map("name") @db.VarChar(100)
  type      FoodType @map("type")
  brandName String   @default("") @map("brand_name") @db.VarChar(100)

  ownerUser   Profile? @relation(fields: [ownerUserId], references: [id])
  ownerUserId String?  @map("owner_user_id") @db.Uuid

  isPublic Boolean @default(false) @map("is_public")

  servings Serving[]

  favouritedFoods FavouriteFood[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("foods")
}

model FavouriteFood {
  user   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String  @map("user_id") @db.Uuid
  food   Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)
  foodId String  @map("food_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  @@id([userId, foodId])
  @@map("favourite_foods")
}

model Serving {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerFood   Food   @relation(fields: [ownerFoodId], references: [id], onDelete: Cascade)
  ownerFoodId String @map("owner_food_id") @db.Uuid

  servingUnit        ServingUnit @map("serving_unit")
  servingSize        Decimal     @map("serving_size")
  displayServingUnit String      @map("display_serving_unit") @db.VarChar(100)
  displayServingSize Decimal     @map("display_serving_size")
  cost               Decimal?    @map("cost")
  calories           Decimal     @map("calories")
  carbs              Decimal     @map("carbs")
  protein            Decimal     @map("protein")
  fat                Decimal     @map("fat")
  saturatedFat       Decimal?    @map("saturated_fat")
  polyunsaturatedFat Decimal?    @map("polyunsaturated_fat")
  monounsaturatedFat Decimal?    @map("monounsaturated_fat")
  transFat           Decimal?    @map("trans_fat")
  cholesterol        Decimal?    @map("cholesterol")
  fiber              Decimal?    @map("fiber")
  sugar              Decimal?    @map("sugar")
  addedSugars        Decimal?    @map("added_sugars")
  sodium             Decimal?    @map("sodium")
  potassium          Decimal?    @map("potassium")
  vitaminA           Decimal?    @map("vitamin_a")
  vitaminC           Decimal?    @map("vitamin_c")
  vitaminD           Decimal?    @map("vitamin_d")
  calcium            Decimal?    @map("calcium")
  iron               Decimal?    @map("iron")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  costOverrides ServingCostOverride[]
  ingredientsOf Ingredient[]

  @@map("servings")
}

model ServingCostOverride {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user      Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String  @map("user_id") @db.Uuid
  serving   Serving @relation(fields: [servingId], references: [id], onDelete: Cascade)
  servingId String  @map("serving_id") @db.Uuid

  cost Decimal @map("cost")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, servingId])
  @@map("serving_cost_overrides")
}

model Creation {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  user        Profile?     @relation(fields: [ownerUserId], references: [id])
  ownerUserId String?      @map("owner_user_id") @db.Uuid
  name        String       @map("name") @db.VarChar(100)
  type        CreationType @map("type")
  isPublic    Boolean      @default(false) @map("is_public")

  ingredients Ingredient[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("creations")
}

model Ingredient {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  creation   Creation @relation(fields: [creationId], references: [id], onDelete: Cascade)
  creationId String   @map("creation_id") @db.Uuid
  serving    Serving  @relation(fields: [servingId], references: [id], onDelete: Cascade)
  servingId  String   @map("serving_id") @db.Uuid

  amount Decimal @map("amount")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ingredients")
}

enum FoodType {
  GENERIC
  BRAND
}

enum ServingUnit {
  ML
  G
  OZ
}

enum CreationType {
  MEAL
  RECIPE
}
